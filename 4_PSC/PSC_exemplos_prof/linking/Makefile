#
# Make user manual: https://www.gnu.org/software/make/manual/ 
#

# Targets:
# use-liba:	     test program that uses the static library
# use-libso:     test program that that uses the shared library
# use-libso-rt:  test program that that loads the shared library in runtime
# all:			 test programs for all three cases above
# clean:		 cleanup artifacts generated by this Makefile
#

#
#  DEFINE -L for library dirs
#

# Common C compiler and linker flags
COMMON_C_FLAGS = -c -m64 -g -Wall -std=c99 -pedantic
COMMON_LINKER_FLAGS = -g -m64

# use-liba target
use-liba: use-lib.o libvector.a
	gcc $(COMMON_LINKER_FLAGS) -o use-liba  use-lib.o ./libvector.a

#use-libso target
use-libso: use-lib.o libvector.so
	gcc $(COOMON_LINKER_FLAGS) -o use-libso  use-lib.o ./libvector.so

#use-libso-rt target
use-libso-rt : use-libso-rt.o libvector.so
	gcc -rdynamic $(COMMON_LINKER_FLAGS) -o use-libso-rt use-libso-rt.o -ldl

all: use-liba use-libso use-libso-rt
	
# build static library 
libvector.a : addvec.o multvec.o
	ar -rcsv ./libvector.a addvec.o multvec.o

# build the shared object (dynamic link library)
libvector.so : addvec_pic.o multvec_pic.o
	gcc -shared $(COMMON_LINKER_FLAGS) -o ./libvector.so addvec_pic.o multvec_pic.o

# application files
use-lib.o: use-lib.c vector.h
	gcc $(COMMON_C_FLAGS) -o use-lib.o use-lib.c
	
use-libso-rt.o: use-libso-rt.c
	gcc $(COMMON_C_FLAGS) -o use-libso-rt.o use-libso-rt.c

# compile addvec.c in order to add to static library
addvec.o: addvec.c vector.h
	gcc $(COMMON_C_FLAGS) -o addvec.o addvec.c

# compile multvec.c in order to add to static library
multvec.o: multvec.c vector.h
	gcc $(COMMON_C_FLAGS) -o multvec.o multvec.c

# compile addvec.c with "position independent code" option in order to add to shared object
addvec_pic.o: addvec.c vector.h
	gcc $(COMMON_C_FLAGS) -fPIC -o addvec_pic.o addvec.c

# compile multvec.c with "position independent code" option in order to add to shared object
multvec_pic.o: multvec.c vector.h
	gcc $(COMMON_C_FLAGS) -fPIC -o multvec_pic.o multvec.c

# clean artifacts generated by this makefile (phony target: it is not really a name of a file)
clean:
	@rm -f use-liba use-libso use-libso-rt libvector.a libvector.so *.o 2>/dev/null | true
